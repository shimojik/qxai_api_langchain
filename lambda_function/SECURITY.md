# セキュリティに関する注意事項

本システムは本番環境で利用することを想定していますので、セキュリティに関して以下の点に注意してください。

## APIキーの管理

- **環境変数の利用**: OpenAI APIキーなどの機密情報は必ず環境変数として設定してください。
  - ローカル開発時: `.env` ファイルを使用（Gitでは管理しない）
  - 本番環境: Lambda環境変数として設定
- **キーの直接記述禁止**: コード内に直接APIキーを記述しないでください。
- **キーのローテーション**: 定期的にAPIキーをローテーションする仕組みを検討してください。

## Lambdaのセキュリティ設定

### IAMロールの設定

- 最小権限の原則に従い、必要最小限の権限だけを持つIAMロールを使用してください。
- 以下は基本的な権限セット例です：

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "logs:CreateLogGroup",
        "logs:CreateLogStream",
        "logs:PutLogEvents"
      ],
      "Resource": "arn:aws:logs:*:*:*"
    }
  ]
}
```

### VPC設定

より高いセキュリティが必要な場合は、以下の設定を検討してください：

- プライベートVPC内にLambdaをデプロイする
- VPCエンドポイントを使用してAWSサービスにアクセスする
- ネットワークACLとセキュリティグループでアクセス制限を設定する

### 暗号化

- Lambda環境変数の暗号化にはAWS KMSを使用してください。
- 保管データに機密情報が含まれる場合は、S3のサーバーサイド暗号化を設定してください。

## APIゲートウェイとの統合

APIゲートウェイを通じてLambdaを公開する場合：

- API Keyを設定して認証を強制する
- WAF（Web Application Firewall）を設定して悪意あるリクエストからの保護を行う
- スロットリングを設定して過剰なリクエストを防止する
- CORSを適切に設定し、必要なドメインからのアクセスのみを許可する

### 認証

以下のいずれかの認証方法を実装することを推奨します：

- APIキー認証（簡易な場合）
- IAM認証（AWSリソース間）
- Cognitoユーザープール（ユーザー認証）
- カスタムオーソライザー（独自の認証ロジックが必要な場合）

## プロンプトインジェクション対策

- ユーザー入力は常に検証し、有害なプロンプトを検出するロジックを実装する
- プロンプトの構築前に入力を適切にエスケープまたはサニタイズする

## ロギングとモニタリング

- CloudWatchを使用してLambdaのログを収集し監視
- 機密情報はログに出力しない仕組みとする（入力値のマスキングなど）
- CloudWatch Alarmsを設定して異常を検知する

## 定期的なセキュリティレビュー

- 依存パッケージを定期的に更新し、脆弱性がないか確認
- AWSのセキュリティベストプラクティスに従って構成を確認
- セキュリティテストを定期的に実施（侵入テストなど）

## 事業継続計画

- 重要なデータのバックアップを確保
- 障害発生時の復旧手順を文書化
- 複数リージョンへのデプロイを検討（高可用性が要求される場合）

---

このドキュメントは一般的なセキュリティ対策の概要であり、具体的な実装はお客様の環境やセキュリティ要件に合わせて適切に行ってください。 
